import{a as _}from"./chunk-QB55GBCV.js";import{Ac as C,B as y,C as v,Q as E,T as u,V as A,W as j,Z as R,a as $,b as x,d as S,g as p,h as M,i as W,j as f,y as k,ya as T,z as O}from"./chunk-UUFN4DK2.js";var I={url:"",deserializer:i=>JSON.parse(i.data),serializer:i=>JSON.stringify(i)},U="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",b=class i extends M{constructor(e,t){if(super(),this._socket=null,e instanceof S)this.destination=t,this.source=e;else{let o=this._config=Object.assign({},I);if(this._output=new p,typeof e=="string")o.url=e;else for(let r in e)e.hasOwnProperty(r)&&(o[r]=e[r]);if(!o.WebSocketCtor&&WebSocket)o.WebSocketCtor=WebSocket;else if(!o.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new f}}lift(e){let t=new i(this._config,this.destination);return t.operator=e,t.source=this,t}_resetState(){this._socket=null,this.source||(this.destination=new f),this._output=new p}multiplex(e,t,o){let r=this;return new S(s=>{try{r.next(e())}catch(a){s.error(a)}let n=r.subscribe({next:a=>{try{o(a)&&s.next(a)}catch(c){s.error(c)}},error:a=>s.error(a),complete:()=>s.complete()});return()=>{try{r.next(t())}catch(a){s.error(a)}n.unsubscribe()}})}_connectSocket(){let{WebSocketCtor:e,protocol:t,url:o,binaryType:r}=this._config,s=this._output,n=null;try{n=t?new e(o,t):new e(o),this._socket=n,r&&(this._socket.binaryType=r)}catch(c){s.error(c);return}let a=new $(()=>{this._socket=null,n&&n.readyState===1&&n.close()});n.onopen=c=>{let{_socket:l}=this;if(!l){n.close(),this._resetState();return}let{openObserver:w}=this._config;w&&w.next(c);let m=this.destination;this.destination=x.create(h=>{if(n.readyState===1)try{let{serializer:d}=this._config;n.send(d(h))}catch(d){this.destination.error(d)}},h=>{let{closingObserver:d}=this._config;d&&d.next(void 0),h&&h.code?n.close(h.code,h.reason):s.error(new TypeError(U)),this._resetState()},()=>{let{closingObserver:h}=this._config;h&&h.next(void 0),n.close(),this._resetState()}),m&&m instanceof f&&a.add(m.subscribe(this.destination))},n.onerror=c=>{this._resetState(),s.error(c)},n.onclose=c=>{n===this._socket&&this._resetState();let{closeObserver:l}=this._config;l&&l.next(c),c.wasClean?s.complete():s.error(c)},n.onmessage=c=>{try{let{deserializer:l}=this._config;s.next(l(c))}catch(l){s.error(l)}}}_subscribe(e){let{source:t}=this;return t?t.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add(()=>{let{_socket:o}=this;this._output.observers.length===0&&(o&&(o.readyState===1||o.readyState===0)&&o.close(),this._resetState())}),e)}unsubscribe(){let{_socket:e}=this;e&&(e.readyState===1||e.readyState===0)&&e.close(),this._resetState(),super.unsubscribe()}};function g(i){return new b(i)}var B=!_.production,et=(()=>{class i{socket$=null;destroy$=new p;reconnectAttempts=0;maxReconnectAttempts=5;reconnectInterval=3e3;connectionStateSignal=T("disconnected");connectionState=this.connectionStateSignal.asReadonly();isConnected=C(()=>this.connectionStateSignal()==="connected");claimUpdates$=new p;metrics$=new W(null);notifications$=new p;connect(){if(this.socket$||this.connectionStateSignal()==="connected")return;if(B){this.connectMock();return}this.connectionStateSignal.set("connecting");let t={url:_.wsUrl,openObserver:{next:()=>{console.log("WebSocket connected"),this.connectionStateSignal.set("connected"),this.reconnectAttempts=0}},closeObserver:{next:()=>{console.log("WebSocket closed"),this.connectionStateSignal.set("disconnected"),this.socket$=null,this.attemptReconnect()}}};this.socket$=g(t),this.socket$.pipe(u(this.destroy$),A({error:o=>{console.error("WebSocket error:",o),this.connectionStateSignal.set("error")}})).subscribe({next:o=>this.handleMessage(o),error:o=>console.error("WebSocket subscription error:",o)}),this.startHeartbeat()}connectMock(){console.log("WebSocket: Running in mock mode (backend not required)"),this.connectionStateSignal.set("connected"),this.emitMockMetrics(),O(5e3).pipe(u(this.destroy$)).subscribe(()=>{this.emitMockMetrics()})}emitMockMetrics(){let t={claims_per_minute:Math.floor(Math.random()*50)+30,pending_count:Math.floor(Math.random()*20)+15,processing_count:Math.floor(Math.random()*10)+5,approved_today:Math.floor(Math.random()*100)+150,denied_today:Math.floor(Math.random()*20)+10};this.metrics$.next(t)}disconnect(){this.destroy$.next(),this.destroy$.complete(),this.socket$&&(this.socket$.complete(),this.socket$=null),this.connectionStateSignal.set("disconnected")}getClaimUpdates(){return this.claimUpdates$.pipe(v(100),y(t=>t.length>0),j(500),E(1))}getMetrics(){return this.metrics$.asObservable()}getNotifications(){return this.notifications$.asObservable()}send(t){this.socket$&&this.isConnected()&&this.socket$.next({type:t.type??"notification",payload:t.payload,timestamp:new Date().toISOString()})}handleMessage(t){switch(t.type){case"claim_update":this.claimUpdates$.next(t.payload);break;case"metrics":this.metrics$.next(t.payload);break;case"notification":this.notifications$.next(t.payload);break;case"heartbeat":this.send({type:"heartbeat",payload:{pong:!0}});break;default:console.warn("Unknown WebSocket message type:",t.type)}}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("Max reconnection attempts reached"),this.connectionStateSignal.set("error");return}this.reconnectAttempts++;let t=this.reconnectInterval*Math.pow(2,this.reconnectAttempts-1);console.log(`Attempting reconnect in ${t}ms (attempt ${this.reconnectAttempts})`),k(t).pipe(u(this.destroy$)).subscribe(()=>{this.connect()})}startHeartbeat(){k(3e4,3e4).pipe(u(this.destroy$),y(()=>this.isConnected())).subscribe(()=>{this.send({type:"heartbeat",payload:{ping:!0}})})}static \u0275fac=function(o){return new(o||i)};static \u0275prov=R({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();export{et as a};
