name: Lint

# Run linters on pull requests and pushes to main
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  POETRY_VERSION: "2.2.1"  # Updated to match local/Docker environment (2025-11-14)

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            .venv
          key: poetry-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            poetry-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 - --version ${{ env.POETRY_VERSION }}
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Install dependencies
        run: poetry install --no-interaction --no-ansi

      - name: Run Ruff linter
        run: |
          poetry run ruff check . --output-format=github
        continue-on-error: false

      - name: Run Ruff formatter check
        run: |
          poetry run ruff format --check .
        continue-on-error: false

      - name: Run mypy type checker
        run: |
          poetry run mypy src/ --strict --ignore-missing-imports --no-warn-return-any --exclude 'src/(tasks|mcp|services)/'
        continue-on-error: false

      - name: Check Poetry configuration
        run: |
          poetry check --lock

      - name: Check for outdated dependencies
        run: |
          poetry show --outdated
        continue-on-error: true

  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit hooks
        run: pre-commit run --all-files --show-diff-on-failure

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v18
        with:
          globs: "**/*.md"
        continue-on-error: true

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run yamllint
        run: |
          pip install yamllint
          yamllint .
        continue-on-error: true

  docker-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          ignore: DL3008,DL3013
        continue-on-error: true

  lint-summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [lint, pre-commit]
    if: always()

    steps:
      - name: Check lint results
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || [ "${{ needs.pre-commit.result }}" != "success" ]; then
            echo "Linting failed!"
            exit 1
          fi
          echo "All linters passed!"
